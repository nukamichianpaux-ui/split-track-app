import React, { useMemo, useState } from "react";
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  SafeAreaView,
  TextInput,
  Switch,
  Modal,
  Pressable,
  Alert,
} from "react-native";
import { Ionicons } from "@expo/vector-icons";
import { NavigationContainer } from "@react-navigation/native";
import { createNativeStackNavigator } from "@react-navigation/native-stack";

const Stack = createNativeStackNavigator();

const initialCategories = [
  { id: "groceries", label: "Groceries", icon: "cart-outline", monthlyBudget: 720 },
  { id: "dining", label: "Dining Out", icon: "restaurant-outline", monthlyBudget: 128 },
  { id: "biggi", label: "Biggi Fun Money", icon: "cash-outline", monthlyBudget: 0 },
  { id: "anna", label: "Anna Fun Money", icon: "cash-outline", monthlyBudget: 0 },
  { id: "movies", label: "Movies", icon: "film-outline", monthlyBudget: 0 },
  { id: "gas", label: "Gas", icon: "car-outline", monthlyBudget: 80 },
  { id: "sinking", label: "Sinking Funds", icon: "archive-outline", monthlyBudget: 0 },
  { id: "medication", label: "Medication", icon: "medkit-outline", monthlyBudget: 30 },
  { id: "therapy", label: "Therapy", icon: "heart-outline", monthlyBudget: 80 },
  { id: "tuition", label: "Tuition", icon: "school-outline", monthlyBudget: 0 },
  { id: "np", label: "NP Appt", icon: "clipboard-outline", monthlyBudget: 40 },
  { id: "household", label: "Household Supplies", icon: "home-outline", monthlyBudget: 0 },
];

function HomeScreen({ navigation, categories, onDeleteCategory }) {
  const [actionsOpen, setActionsOpen] = useState(false);
  const [confirmOpen, setConfirmOpen] = useState(false);
  const [selectedId, setSelectedId] = useState(null);

  const selected = useMemo(
    () => categories.find((c) => c.id === selectedId) || null,
    [categories, selectedId]
  );

  function openActions(id) {
    setSelectedId(id);
    setActionsOpen(true);
  }

  function goEdit() {
    setActionsOpen(false);
    if (!selected) return;
    navigation.navigate("EditCategory", { categoryId: selected.id });
  }

  function askDelete() {
    setActionsOpen(false);
    setConfirmOpen(true);
  }

  function doDelete() {
    if (!selected) return;
    setConfirmOpen(false);
    onDeleteCategory(selected.id);
    setSelectedId(null);
  }

  return (
    <SafeAreaView style={homeStyles.safe}>
      <View style={homeStyles.screen}>
        <View style={homeStyles.grid}>
          {categories.map((c) => (
            <TouchableOpacity
              key={c.id}
              style={homeStyles.tile}
              activeOpacity={0.85}
              onPress={() => navigation.navigate("AddTransaction", { categoryLabel: c.label })}
              onLongPress={() => openActions(c.id)}
              delayLongPress={350}
            >
              <View style={homeStyles.iconBox}>
                <Ionicons name={c.icon} size={34} color="#29c7c9" />
              </View>
              <Text style={homeStyles.tileText}>{c.label}</Text>
            </TouchableOpacity>
          ))}
        </View>

        <TouchableOpacity
          style={homeStyles.fab}
          activeOpacity={0.85}
          onPress={() => navigation.navigate("AddTransaction", { categoryLabel: "" })}
        >
          <Ionicons name="add" size={28} color="#e7edf3" />
        </TouchableOpacity>

        <View style={homeStyles.bottomBar}>
          <TouchableOpacity
            style={homeStyles.tab}
            onPress={() => navigation.navigate("AddTransaction", { categoryLabel: "" })}
          >
            <Ionicons name="add-circle-outline" size={26} color="#29c7c9" />
          </TouchableOpacity>

          <TouchableOpacity style={homeStyles.tab} onPress={() => {}}>
            <Ionicons name="grid-outline" size={24} color="#cfd6de" />
          </TouchableOpacity>
          <TouchableOpacity style={homeStyles.tab} onPress={() => {}}>
            <Ionicons name="home-outline" size={24} color="#cfd6de" />
          </TouchableOpacity>
          <TouchableOpacity style={homeStyles.tab} onPress={() => {}}>
            <Ionicons name="cart-outline" size={24} color="#cfd6de" />
          </TouchableOpacity>
          <TouchableOpacity style={homeStyles.tab} onPress={() => {}}>
            <Ionicons name="menu-outline" size={24} color="#cfd6de" />
          </TouchableOpacity>
        </View>

        <Modal transparent visible={actionsOpen} animationType="fade" onRequestClose={() => setActionsOpen(false)}>
          <Pressable style={uiStyles.backdrop} onPress={() => setActionsOpen(false)}>
            <Pressable style={uiStyles.sheet} onPress={() => {}}>
              <Text style={uiStyles.sheetTitle}>{selected ? selected.label : "Category"}</Text>

              <TouchableOpacity style={uiStyles.sheetBtn} activeOpacity={0.85} onPress={goEdit}>
                <Ionicons name="create-outline" size={20} color="#e7edf3" />
                <Text style={uiStyles.sheetBtnText}>Edit</Text>
              </TouchableOpacity>

              <TouchableOpacity style={uiStyles.sheetBtn} activeOpacity={0.85} onPress={askDelete}>
                <Ionicons name="trash-outline" size={20} color="#ff7a7a" />
                <Text style={[uiStyles.sheetBtnText, { color: "#ff7a7a" }]}>Delete</Text>
              </TouchableOpacity>
            </Pressable>
          </Pressable>
        </Modal>

        <Modal transparent visible={confirmOpen} animationType="fade" onRequestClose={() => setConfirmOpen(false)}>
          <Pressable style={uiStyles.backdrop} onPress={() => setConfirmOpen(false)}>
            <Pressable style={uiStyles.confirmBox} onPress={() => {}}>
              <Text style={uiStyles.confirmTitle}>Delete category?</Text>
              <Text style={uiStyles.confirmBody}>Are you sure you want to delete this category?</Text>

              <View style={uiStyles.confirmRow}>
                <TouchableOpacity
                  style={[uiStyles.confirmBtn, uiStyles.confirmCancel]}
                  activeOpacity={0.85}
                  onPress={() => setConfirmOpen(false)}
                >
                  <Text style={uiStyles.confirmCancelText}>Cancel</Text>
                </TouchableOpacity>

                <TouchableOpacity
                  style={[uiStyles.confirmBtn, uiStyles.confirmDelete]}
                  activeOpacity={0.85}
                  onPress={doDelete}
                >
                  <Text style={uiStyles.confirmDeleteText}>Delete</Text>
                </TouchableOpacity>
              </View>
            </Pressable>
          </Pressable>
        </Modal>
      </View>
    </SafeAreaView>
  );
}

function EditCategoryScreen({ route, navigation, categories, onSaveCategory }) {
  const categoryId = route?.params?.categoryId;
  const current = categories.find((c) => c.id === categoryId);

  const [label, setLabel] = useState(current ? current.label : "");
  const [icon, setIcon] = useState(current ? current.icon : "grid-outline");
  const [monthlyBudget, setMonthlyBudget] = useState(
    current && typeof current.monthlyBudget === "number" ? String(current.monthlyBudget) : "0"
  );

  if (!current) {
    return (
      <SafeAreaView style={txStyles.safe}>
        <View style={txStyles.container}>
          <Text style={{ color: "#e7edf3" }}>Category not found.</Text>
        </View>
      </SafeAreaView>
    );
  }

  function save() {
    const parsed = Number(monthlyBudget);
    if (!label.trim()) {
      Alert.alert("Name required", "Please enter a category name.");
      return;
    }
    if (Number.isNaN(parsed) || parsed < 0) {
      Alert.alert("Invalid budget", "Monthly budget must be a number 0 or higher.");
      return;
    }
    onSaveCategory({ id: current.id, label: label.trim(), icon: icon.trim(), monthlyBudget: parsed });
    navigation.goBack();
  }

  return (
    <SafeAreaView style={txStyles.safe}>
      <View style={txStyles.container}>
        <View style={txStyles.headerRow}>
          <TouchableOpacity onPress={() => navigation.goBack()} style={txStyles.headerIcon}>
            <Ionicons name="chevron-back" size={26} color="#cfd6de" />
          </TouchableOpacity>
          <Text style={txStyles.headerTitle}>Edit category</Text>
          <View style={{ width: 60 }} />
        </View>

        <Text style={txStyles.label}>Name</Text>
        <View style={uiStyles.field}>
          <TextInput
            value={label}
            onChangeText={setLabel}
            placeholder="Category name"
            placeholderTextColor="#7f8a96"
            style={uiStyles.fieldInput}
          />
        </View>

        <Text style={txStyles.label}>Icon</Text>
        <View style={uiStyles.fieldRow}>
          <View style={uiStyles.iconPreview}>
            <Ionicons name={icon || "help-circle-outline"} size={22} color="#29c7c9" />
          </View>
          <TextInput
            value={icon}
            onChangeText={setIcon}
            placeholder="Ionicons name, ex: cart-outline"
            placeholderTextColor="#7f8a96"
            style={[uiStyles.fieldInput, { flex: 1 }]}
            autoCapitalize="none"
            autoCorrect={false}
          />
        </View>

        <Text style={txStyles.label}>Monthly budget allowance</Text>
        <View style={uiStyles.field}>
          <TextInput
            value={monthlyBudget}
            onChangeText={setMonthlyBudget}
            placeholder="0"
            placeholderTextColor="#7f8a96"
            keyboardType="numeric"
            style={uiStyles.fieldInput}
          />
        </View>

        <TouchableOpacity style={txStyles.saveBtn} activeOpacity={0.85} onPress={save}>
          <Text style={txStyles.saveText}>Save</Text>
        </TouchableOpacity>
      </View>
    </SafeAreaView>
  );
}

function AddTransactionScreen({ route, navigation }) {
  const categoryLabel = route?.params?.categoryLabel ?? "";
  const [isExpense, setIsExpense] = useState(true);
  const [amount, setAmount] = useState("");
  const [notes, setNotes] = useState("");

  return (
    <SafeAreaView style={txStyles.safe}>
      <View style={txStyles.container}>
        <View style={txStyles.headerRow}>
          <TouchableOpacity onPress={() => navigation.goBack()} style={txStyles.headerIcon}>
            <Ionicons name="chevron-back" size={26} color="#cfd6de" />
          </TouchableOpacity>
          <Text style={txStyles.headerTitle}>Add transaction</Text>
          <View style={txStyles.headerRight}>
            <Ionicons name="notifications-outline" size={20} color="#cfd6de" />
            <Ionicons name="pricetag-outline" size={20} color="#cfd6de" style={{ marginLeft: 14 }} />
            <Ionicons name="sync-outline" size={20} color="#cfd6de" style={{ marginLeft: 14 }} />
          </View>
        </View>

        <View style={txStyles.row}>
          <Ionicons name="calendar-outline" size={20} color="#9aa5b1" />
          <Text style={txStyles.rowText}>Wed 31 Dec 25  04:50 am</Text>
        </View>

        <View style={txStyles.toggleRow}>
          <View style={txStyles.toggleItem}>
            <View style={[txStyles.dot, isExpense ? txStyles.dotOn : txStyles.dotOff]} />
            <Text style={txStyles.toggleText}>Expense</Text>
          </View>

          <Switch
            value={!isExpense}
            onValueChange={(v) => setIsExpense(!v)}
            thumbColor="#cfd6de"
            trackColor={{ false: "#2a2f35", true: "#2a2f35" }}
          />

          <View style={txStyles.toggleItem}>
            <View style={[txStyles.dot, !isExpense ? txStyles.dotOn : txStyles.dotOff]} />
            <Text style={txStyles.toggleText}>Income</Text>
          </View>
        </View>

        <Text style={txStyles.label}>Amount</Text>
        <View style={txStyles.inputRow}>
          <Text style={txStyles.currency}>$</Text>
          <TextInput
            value={amount}
            onChangeText={setAmount}
            placeholder=""
            placeholderTextColor="#7f8a96"
            keyboardType="numeric"
            style={txStyles.amountInput}
          />
          <View style={txStyles.calcBtn}>
            <Ionicons name="calculator-outline" size={18} color="#b8c2cc" />
          </View>
        </View>

        <Text style={txStyles.label}>Category</Text>
        <TouchableOpacity style={txStyles.categoryRow} activeOpacity={0.85} onPress={() => {}}>
          <View style={txStyles.catLeft}>
            <Ionicons name="nutrition-outline" size={22} color="#ff7a7a" />
            <Text style={txStyles.categoryText}>{categoryLabel || "Select category"}</Text>
          </View>
          <Ionicons name="chevron-forward" size={22} color="#9aa5b1" />
        </TouchableOpacity>

        <Text style={txStyles.label}>Notes (optional)</Text>
        <TextInput
          value={notes}
          onChangeText={setNotes}
          placeholder=""
          placeholderTextColor="#7f8a96"
          style={txStyles.notes}
          multiline
        />

        <TouchableOpacity style={txStyles.saveBtn} activeOpacity={0.85} onPress={() => {}}>
          <Text style={txStyles.saveText}>Save</Text>
        </TouchableOpacity>
      </View>
    </SafeAreaView>
  );
}

export default function App() {
  const [categories, setCategories] = useState(initialCategories);

  function onSaveCategory(updated) {
    setCategories((prev) => prev.map((c) => (c.id === updated.id ? { ...c, ...updated } : c)));
  }

  function onDeleteCategory(id) {
    setCategories((prev) => prev.filter((c) => c.id !== id));
  }

  return (
    <NavigationContainer>
      <Stack.Navigator>
        <Stack.Screen name="Home" options={{ headerShown: false }}>
          {(props) => (
            <HomeScreen {...props} categories={categories} onDeleteCategory={onDeleteCategory} />
          )}
        </Stack.Screen>

        <Stack.Screen name="AddTransaction" component={AddTransactionScreen} options={{ headerShown: false }} />

        <Stack.Screen name="EditCategory" options={{ headerShown: false }}>
          {(props) => (
            <EditCategoryScreen
              {...props}
              categories={categories}
              onSaveCategory={onSaveCategory}
            />
          )}
        </Stack.Screen>
      </Stack.Navigator>
    </NavigationContainer>
  );
}

const homeStyles = StyleSheet.create({
  safe: { flex: 1, backgroundColor: "#1f2328" },
  screen: { flex: 1, paddingHorizontal: 16, paddingTop: 84, paddingBottom: 24 },
  grid: {
    flex: 1,
    flexDirection: "row",
    flexWrap: "wrap",
    justifyContent: "space-between",
    alignContent: "flex-start",
    gap: 14,
    marginBottom: 24,
  },
  tile: {
    width: "48%",
    backgroundColor: "#3a3f46",
    borderRadius: 14,
    paddingVertical: 16,
    paddingHorizontal: 10,
    alignItems: "center",
  },
  iconBox: {
    width: 60,
    height: 60,
    borderRadius: 14,
    borderWidth: 1,
    borderColor: "#50575f",
    alignItems: "center",
    justifyContent: "center",
    backgroundColor: "#2a2f35",
    marginBottom: 10,
  },
  tileText: { fontSize: 13, color: "#e7edf3", textAlign: "center" },
  bottomBar: {
    height: 56,
    backgroundColor: "#2a2f35",
    borderRadius: 16,
    flexDirection: "row",
    justifyContent: "space-around",
    alignItems: "center",
    borderWidth: 1,
    borderColor: "#3a3f46",
  },
  tab: { width: 52, height: 44, alignItems: "center", justifyContent: "center" },
  fab: {
    position: "absolute",
    right: 18,
    bottom: 86,
    width: 56,
    height: 56,
    borderRadius: 18,
    backgroundColor: "#29c7c9",
    alignItems: "center",
    justifyContent: "center",
  },
});

const txStyles = StyleSheet.create({
  safe: { flex: 1, backgroundColor: "#1f2328" },
  container: { flex: 1, paddingHorizontal: 18, paddingTop: 26 },
  headerRow: { flexDirection: "row", alignItems: "center", justifyContent: "space-between", marginBottom: 18 },
  headerIcon: { width: 40, height: 40, alignItems: "center", justifyContent: "center" },
  headerTitle: { color: "#e7edf3", fontSize: 18 },
  headerRight: { flexDirection: "row", alignItems: "center" },
  row: { flexDirection: "row", alignItems: "center", marginBottom: 22 },
  rowText: { color: "#cfd6de", marginLeft: 10, fontSize: 16 },
  toggleRow: { flexDirection: "row", alignItems: "center", justifyContent: "space-between", marginBottom: 22 },
  toggleItem: { flexDirection: "row", alignItems: "center" },
  toggleText: { color: "#cfd6de", marginLeft: 10, fontSize: 16 },
  dot: { width: 18, height: 18, borderRadius: 9, borderWidth: 3 },
  dotOn: { borderColor: "#7b68ee", backgroundColor: "transparent" },
  dotOff: { borderColor: "#50575f", backgroundColor: "transparent" },
  label: { color: "#cfd6de", fontSize: 14, marginBottom: 10 },
  inputRow: { flexDirection: "row", alignItems: "center", backgroundColor: "#3a3f46", borderRadius: 16, paddingHorizontal: 14, height: 64, marginBottom: 22 },
  currency: { color: "#e7edf3", fontSize: 28, marginRight: 10 },
  amountInput: { flex: 1, color: "#e7edf3", fontSize: 22 },
  calcBtn: { width: 38, height: 38, borderRadius: 12, backgroundColor: "#4a4f57", alignItems: "center", justifyContent: "center" },
  categoryRow: { flexDirection: "row", alignItems: "center", justifyContent: "space-between", backgroundColor: "#3a3f46", borderRadius: 16, paddingHorizontal: 14, height: 64, marginBottom: 22 },
  catLeft: { flexDirection: "row", alignItems: "center" },
  categoryText: { color: "#e7edf3", marginLeft: 12, fontSize: 16 },
  notes: { backgroundColor: "#3a3f46", borderRadius: 16, paddingHorizontal: 14, paddingTop: 14, color: "#e7edf3", height: 92, marginBottom: 28 },
  saveBtn: { alignSelf: "center", backgroundColor: "#4a4f57", paddingHorizontal: 44, height: 52, borderRadius: 18, alignItems: "center", justifyContent: "center" },
  saveText: { color: "#b8c2cc", fontSize: 16 },
});

const uiStyles = StyleSheet.create({
  backdrop: { flex: 1, backgroundColor: "rgba(0,0,0,0.55)", justifyContent: "flex-end" },
  sheet: {
    backgroundColor: "#2a2f35",
    paddingHorizontal: 16,
    paddingTop: 14,
    paddingBottom: 22,
    borderTopLeftRadius: 18,
    borderTopRightRadius: 18,
    borderWidth: 1,
    borderColor: "#3a3f46",
  },
  sheetTitle: { color: "#e7edf3", fontSize: 14, marginBottom: 12 },
  sheetBtn: { flexDirection: "row", alignItems: "center", paddingVertical: 12 },
  sheetBtnText: { color: "#e7edf3", marginLeft: 10, fontSize: 16 },

  confirmBox: {
    marginHorizontal: 18,
    marginBottom: 120,
    backgroundColor: "#2a2f35",
    borderRadius: 18,
    paddingHorizontal: 16,
    paddingTop: 16,
    paddingBottom: 14,
    borderWidth: 1,
    borderColor: "#3a3f46",
  },
  confirmTitle: { color: "#e7edf3", fontSize: 16, marginBottom: 8 },
  confirmBody: { color: "#cfd6de", fontSize: 14, marginBottom: 14 },
  confirmRow: { flexDirection: "row", justifyContent: "flex-end" },
  confirmBtn: { paddingHorizontal: 14, height: 40, borderRadius: 12, alignItems: "center", justifyContent: "center", marginLeft: 10 },
  confirmCancel: { backgroundColor: "#3a3f46" },
  confirmDelete: { backgroundColor: "#ff7a7a" },
  confirmCancelText: { color: "#e7edf3", fontSize: 14 },
  confirmDeleteText: { color: "#1f2328", fontSize: 14 },

  field: {
    backgroundColor: "#3a3f46",
    borderRadius: 16,
    paddingHorizontal: 14,
    height: 54,
    justifyContent: "center",
    marginBottom: 18,
  },
  fieldRow: {
    flexDirection: "row",
    alignItems: "center",
    backgroundColor: "#3a3f46",
    borderRadius: 16,
    paddingHorizontal: 14,
    height: 54,
    marginBottom: 18,
  },
  iconPreview: {
    width: 36,
    height: 36,
    borderRadius: 12,
    backgroundColor: "#2a2f35",
    alignItems: "center",
    justifyContent: "center",
    marginRight: 10,
    borderWidth: 1,
    borderColor: "#50575f",
  },
  fieldInput: { color: "#e7edf3", fontSize: 16 },
});
